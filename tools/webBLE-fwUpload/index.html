<button id="connect">Connect with the BLE device</button>

<script>
var deviceName = 'UNISENSE'
const dfuService = '34c2e3b8-34aa-11eb-adc1-0242ac120002';
const dfuAckCharacteristic = '34c2e3be-34aa-11eb-adc1-0242ac120002';
const dfuInternalCharacteristic = '34c2e3b9-34aa-11eb-adc1-0242ac120002';
var bleDevice
var gattService
var gattAckCharacteristic
var gattInternalCharacteristic

  document.querySelector('#connect').addEventListener('click', function() {
    if (isWebBluetoothEnabled()) { connect() }
  })


  function isWebBluetoothEnabled() {
    if (!navigator.bluetooth) {
      console.log('Web Bluetooth is NOT available!')
      return false
    }

    console.log('Web Bluetooth is available!')
    return true
  }

  function getDeviceInfo() {
    let options = {
      filters: [{ name: deviceName}],
      optionalServices: [dfuService]
    }

    console.log('Requesting BLE device info...')
    return navigator.bluetooth.requestDevice(options).then(device => {
      bleDevice = device
    }).catch(error => {
      console.log('Request device error: ' + error)
    })
  }


  function connect() {
    return getDeviceInfo()
    .then(connectGATTdfu)
    .then(connectGATTack)
    .then(writePacket)
    .then(readAck)
    .catch(error => {
      console.log('ERROR: ' + error);
    });
  }


  function connectGATTdfu() {
    console.log('Connecting to BLE device...')
    return bleDevice.gatt.connect()
    .then(server => {
      console.log("Getting server:", server)
      return server.getPrimaryService(dfuService)
    })
    .then(service => {
      gattService = service
      console.log("Getting service:", service)
      return service.getCharacteristic(dfuInternalCharacteristic)
    })
    .then(characteristic => {
      console.log("Looking for characteristic...")
      gattInternalCharacteristic = characteristic
      console.log("gattInternalCharacteristic:", gattInternalCharacteristic)
    })
  }


  function connectGATTack() {
    return gattService.getCharacteristic(dfuAckCharacteristic)
    .then(characteristic => {
      gattAckCharacteristic = characteristic
      console.log("gattAckCharacteristic:", gattAckCharacteristic)
      characteristic.startNotifications()
    })
    .then(_ => {
      console.log('Notifications on ack enabled')
    })
    .catch(error => {
      console.log('[ERROR] Start: ' + error)
    })
  }


  function writePacket() {
    const bytesArray = new Uint8Array(67);
    bytesArray[0] = 0;
    bytesArray[1] = 0;
    bytesArray[2] = 0;
    var i;
    for (i = 3; i < 67; i++) {
      bytesArray[i] = i%8;
    }

    console.log('Writing 67 bytes array...')
    return gattInternalCharacteristic.writeValue(bytesArray)
  }


  function readAck() {
    return gattAckCharacteristic.readValue()
    .then(value =>  {
      ack = value.getUint8(0)
      console.log('Ack is: ', ack)
    })
  }
</script>